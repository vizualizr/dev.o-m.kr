date-created:: [[2026-01-15]]
date-modified:: [[2026-01-15]]
division:: [[makr]]
stack:: frontend
tags:: [[grid-mapper]], [[refactoring]], [[astro]], [[swiss-design]], [[deterministic-layout]]
type::
public:: true
alias:: grid-mapper-refactor
status:: [[ai-generated]]

- ## Summary
	- **Grid Mapper Refactoring**: HTML 프로토타입의 동적 규칙을 프로덕션 코드로 이식하고 결정론적 레이아웃 생성 로직을 구현함.
	- **Dynamic Rules**: [getPossibleDividers](cci:1://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/swiss/_grid-rule-12-sample.html:183:8-221:9) 등의 함수로 최소 셀 너비(3칸)를 고려한 가변 분할 로직 적용.
	- **CSS Flex Transition**: Grid 레이아웃에서 Flexbox + Aspect-Ratio 기반 레이아웃으로 전환.
	- **Deterministic Layout**: 아티클 ID 해시를 시드로 사용하여 새로고침 시에도 동일한 레이아웃 유지.
- ## Steps
	- ### 1. Grid Rule Logic Porting
		- HTML 프로토타입([_grid-rule-12-sample.html](cci:7://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/swiss/_grid-rule-12-sample.html:0:0-0:0))의 로직을 [src/utils/grid-mapper-12 JSON.js](cci:7://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/grid-mapper-12%20JSON.js:0:0-0:0)로 이식.
		- [grid-rule-12-cols.json](cci:7://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/swiss/grid-rule-12-cols.json:0:0-0:0)의 JSON 주석 제거 및 데이터 구조 활용.
	- ### 2. Grid Mapper Rewriting
		- [getPossibleDividers](cci:1://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/swiss/_grid-rule-12-sample.html:183:8-221:9): 재귀적으로 가능한 너비 조합을 모두 계산.
		- [selectDividerWithLeastOverlap](cci:1://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/grid-mapper-12%20JSON.js:91:0-117:1): 상하부 그리드 라인 겹침을 최소화하여 시각적 다양성 확보.
		- `article._gridInfo`: 각 아티클에 `flexRatio`, `rowHeight`, `rowIndex` 등의 메타데이터 주입.
	- ### 3. Deterministic Seeded RNG Implementation
		- [generateSeed](cci:1://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/grid-mapper-12%20JSON.js:11:0-18:1): DJB2 해시 함수로 아티클 ID 문자열을 정수 시드로 변환.
		- [mulberry32](cci:1://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/grid-mapper-12%20JSON.js:20:0-28:1): 시드 기반 난수 생성기 구현.
		- [gridMapper12](cci:1://file:///d:/yonggeun/porter/git/o-m.kr/production/src/utils/grid-mapper-12%20JSON.js:151:0-251:1) 내부의 모든 `Math.random` 호출을 시드형 `rng()`로 교체.
	- ### 4. Component & Style Update
		- **CSS**: `.patchwork-grid`를 Flex column으로, `.patchwork-row`를 Flex row로 변경.
		- **Component**: [Patchwork.astro](cci:7://file:///d:/yonggeun/porter/git/o-m.kr/production/src/components/swiss/Patchwork.astro:0:0-0:0)에서 `_gridClass` 제거, 인라인 스타일(`flex`, `aspect-ratio`) 적용.
		- **Design System**: 디자인 토큰(`--color-outline`)을 활용하여 셀에 `2px solid` 외곽선 적용.
	- ### 5. Finalization
		- 일일 작업 로그 업데이트 및 백업 수행.
- ## Troubleshooting
	- **Issue**: Grid 레이아웃의 `grid-auto-flow`로는 동적인 행 높이와 너비 비율을 동시에 제어하기 어려움.
	- **Solution**: 행 단위로 Flex 컨테이너(`patchwork-row`)를 만들고, 내부 셀에 `flex-grow` 비율과 `aspect-ratio`를 지정하여 해결.
	- **Issue**: 페이지 새로고침 시마다 레이아웃이 급격하게 변경되어 사용자 경험 저하 우려.
	- **Solution**: 콘텐츠(ID) 기반의 결정론적 시드 생성기를 도입하여 콘텐츠 변경 시에만 레이아웃이 바뀌도록 개선.
	- 셀 채우기 로직
	  collapsed:: true
		- 주어진 그리드 안에 랜덤하게 셀을 채우는 로직을 테스트하려고 해.
		- 페이지 최상단에 `randomizer` 버튼을 누르면 임의의 6에서 24까지 임의의 정수를 생성해.
		- 이 정수는 그리드에 들어가야 할 셀의 갯수야.
		- 그리드는 CSS만 써서 그려야 해.
		- 임의의 셀 갯수가 주어지면 아래 규칙에 따라 셀을 채워 넣어봐.
		- 우선 그리드는 12열 그리드고 행은 셀 갯수에 따라 자유롭게 추가 삭제해도 좋아.
		- 각 행에 셀을 채우면 남는 여백이 없어야 해. 만약 셀을 채워도 여백이 남는다면 마지막 셀의 너비나 높이를 조절해 각 행에 남는 공간이 없어야 해.
		- 아래 로직을 정확히 반영하되 최대한 단순하게 작성하면서도 유지보수를 위해 최대한 쉽게 이해할 수 있도록 구현해야 해.
		- 첫 번째 열
			- 첫번 째 열에는 두 개의 셀만 들어갈 수 있고 셀의 높이는 같아. 너비를 채우는 두 셀의 너비 비율은 반드시 1:2 혹은 2:1이어야 해. 첫째 열의 높이는 반드시 첫째 열의 전체 너비의 절반이야.
		- 두 번째 열
			- 두 번째 열에는 세 개 혹은 두 개의 셀만 들어갈 수 있어.
			- 각 셀 사이에 가능한 비율은
				- 셀이 두 개일 경우, 1:2, 2:1이어야 해. 단 첫 번째 열의 셀 비율이 1:2였다면 두 번 열 안의 셀 비율은 2:1, 첫 번째 열의 셀 비율이 2:1였다면 두 번 열 안의 셀 비율은 1:2여야 해.
				- 셀이 세 개일 경우, 1:1:1이야.
			- 두 번째 열의 높이는 너비의 1/3이야.
		- 세 번째 열
			- 세 번째 열에 들어갈 셀의 갯수는 언제나 5에서 두 번째 열의 셀 갯수를 뺀 값이야. 즉 두 번째 열이 3개의 셀을 가지면 세 번째 열은 2개의 셀을 가지고 두 번째 열이 2개의 셀을 가지면 세 번째 열에는 3개의 셀이 있어야 해.
			- 각 셀 사이의 비율은 두 번째 열과 동일해.
			- 세 번째 열의 높이는 두 번째 열 높이의 반이야.
		- 네 번째 열 및 그 아래
			- 네 번째 열과 그 아래에 따라오는 열에는
				- 언제나 세 개의 셀을 넣고 각 셀의 너비 비율은 1:1:1이면 돼.
				- 높이는 너비의 1/3이야.
		-
	- 로직 2 with JSON
	  collapsed:: true
		- 주어진 colCount는 6 이지만 CSS 에서는 12개 컬럼으로 나누도록 해.
		- colCount가 6이면 너비로 지정할 수 있는 colNum은 0부터 6이고 0은 1번째 컬럼의 시작점, 6은 5번째 컬럼의 끝점이야.
		- rows에 각 열마다 규칙을 기술한 거야.
		- order은 몇 번째 줄인지 표시해
		- variants는 해당 행에서 선택할 수 있는 셀 채우기 방식을 기술하는 거야.
		- cellCount는 몇개의 행을 몇 개의 셀로 나눌지,
		- dividerPositions는 colCount를 셀을 나누는 divider이 몇 번째 컬럼에 위치할 수 있는지 알려 주는 거야.
		- dividerPositions에서 divider의 갯수는 cellCounter -1이니까 cellCount가 3이상이면 dividerPositions는 cellCounter-1의 길이만큼 원소를 가지는 배열을 원소로 가지는 2차 배열이야. cellCounter가 3일 경우 divider의 두 개의 위치가 [2, 4]라면 divider의 위치는 colNum 2와 4야.
		- rowHeight도 마찬가지로 주어진 배열 안에서 임의의 값을 선택할 수 있어.
		- 마지막 제일 중요한 규칙은 현재 행의 각 필드 이름은 앞의 행에서 동일한 필드 이름을 가지는 값과 반드시 달라야 해. 갸령 1행의 rowHeight이 3이였다면 2행의 rowHeight는 반드시 이 값과 다른 값을 주어진 배열에서 선택해야 해.
		- 'order':0은 별도의 order가 지시되지 않은 모든 행에 적용하는 규칙이야.
- ## log
	- [[2026-01-15]] Page created.