on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
permissions:
  contents: write
jobs:
  test:
    runs-on: ubuntu-latest
    name: Run the action on a test graph and publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build graph's SPA
        uses: logseq/publish-spa@main
        with:
          graph-directory: .
          theme-mode: light
          accent-color: blue

      # --- [SEO & AdSense ìµœì í™” ì‹œì‘] ---

      - name: AdSense - Inject Meta Tag & Script
        run: |
          # 1. ì†Œìœ ê¶Œ í™•ì¸ ì „ìš© ë©”íƒ€ íƒœê·¸ (êµ¬ê¸€ ë¡œë´‡ì´ ê°€ì¥ ë¨¼ì € ì°¾ëŠ” ê°’)
          META_TAG='<meta name="google-adsense-account" content="ca-pub-9169085414093593">'
          
          # 2. ê´‘ê³  ê²Œì¬ìš© ìŠ¤í¬ë¦½íŠ¸
          ADSENSE_SCRIPT='<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9169085414093593" crossorigin="anonymous"></script>'
          
          # index.htmlì˜ </head> íƒœê·¸ ë°”ë¡œ ì•ì— ë‘ ì½”ë“œë¥¼ ëª¨ë‘ ì‚½ì…
          # \nì„ ì‚¬ìš©í•˜ì—¬ ì¤„ë°”ê¿ˆì„ í•´ì¤˜ì•¼ ì†ŒìŠ¤ ë³´ê¸°ì—ì„œ ê¹”ë”í•˜ê²Œ ë³´ì…ë‹ˆë‹¤.
          sed -i "s|</head>|$META_TAG\n$ADSENSE_SCRIPT\n</head>|g" $GITHUB_WORKSPACE/www/index.html

      - name: AdSense - Create ads.txt
        run: echo "google.com, ca-pub-9169085414093593, DIRECT, f08c47fec0942fa0" > $GITHUB_WORKSPACE/www/ads.txt

      - name: SEO - Create 404.html for History API
        run: cp $GITHUB_WORKSPACE/www/index.html $GITHUB_WORKSPACE/www/404.html

      - name: SEO - Generate Dynamic Sitemap
        run: |
          DOMAIN="https://dev.o-m.kr"
          echo "<?xml version='1.0' encoding='UTF-8'?>" > $GITHUB_WORKSPACE/www/sitemap.xml
          echo "<urlset xmlns='http://www.sitemaps.org/schemas/sitemap/0.9'>" >> $GITHUB_WORKSPACE/www/sitemap.xml
          
          # íŒŒì¼ ëª©ë¡ì„ ì½ì–´ì™€ì„œ XML íŠ¹ìˆ˜ë¬¸ìë¥¼ ì¹˜í™˜í•©ë‹ˆë‹¤.
          find . -maxdepth 2 -name "*.md" ! -name "logseq*" | sed "s|^\./||" | sed "s|.md$||" | while read page; do
            # URL ë‚´ì˜ & ê¸°í˜¸ë¥¼ &amp; ë¡œ ë³€í™˜ (XML ì—ëŸ¬ ë°©ì§€)
            SAFE_PAGE=$(echo "$page" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&apos;/g')
            echo "<url><loc>$DOMAIN/#/page/$SAFE_PAGE</loc></url>" >> $GITHUB_WORKSPACE/www/sitemap.xml
          done
          
          echo "</urlset>" >> $GITHUB_WORKSPACE/www/sitemap.xml

      - name: SEO - Create robots.txt
        run: |
          echo "User-agent: *" > $GITHUB_WORKSPACE/www/robots.txt
          echo "Allow: /" >> $GITHUB_WORKSPACE/www/robots.txt
          echo "Sitemap: https://dev.o-m.kr/sitemap.xml" >> $GITHUB_WORKSPACE/www/robots.txt

      # --- [SEO & AdSense ìµœì í™” ë] ---

      - name: Add a nojekyll file
        run: touch $GITHUB_WORKSPACE/www/.nojekyll

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: www