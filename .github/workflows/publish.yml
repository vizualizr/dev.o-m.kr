on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
permissions:
  contents: write
jobs:
  test:
    runs-on: ubuntu-latest
    name: Run the action on a test graph and publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build graph's SPA
        uses: logseq/publish-spa@main
        with:
          graph-directory: .
          theme-mode: light
          accent-color: blue

      # --- [SEO & AdSense ÏµúÏ†ÅÌôî ÏãúÏûë] ---

      - name: AdSense - Add Auto Ads Code
        run: |
          ADSENSE_CODE='<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9169085414093593" crossorigin="anonymous"></script>'
          sed -i "s|</head>|$ADSENSE_CODE</head>|g" $GITHUB_WORKSPACE/www/index.html

      - name: AdSense - Create ads.txt
        run: echo "google.com, ca-pub-9169085414093593, DIRECT, f08c47fec0942fa0" > $GITHUB_WORKSPACE/www/ads.txt

      - name: SEO - Create 404.html for History API
        run: cp $GITHUB_WORKSPACE/www/index.html $GITHUB_WORKSPACE/www/404.html

      - name: SEO - Generate Sitemap
        run: |
          DOMAIN="https://dev.o-m.kr"
          echo "<?xml version='1.0' encoding='UTF-8'?>" > $GITHUB_WORKSPACE/www/sitemap.xml
          echo "<urlset xmlns='http://www.sitemaps.org/schemas/sitemap/0.9'>" >> $GITHUB_WORKSPACE/www/sitemap.xml
          find . -maxdepth 2 -name "*.md" ! -name "logseq*" | sed "s|^\./||" | sed "s|.md$||" | while read page; do
            echo "<url><loc>$DOMAIN/#/page/$page</loc></url>" >> $GITHUB_WORKSPACE/www/sitemap.xml
          done
          echo "</urlset>" >> $GITHUB_WORKSPACE/www/sitemap.xml

      - name: SEO - Create robots.txt
        run: |
          echo "User-agent: *" > $GITHUB_WORKSPACE/www/robots.txt
          echo "Allow: /" >> $GITHUB_WORKSPACE/www/robots.txt
          echo "Sitemap: https://dev.o-m.kr/sitemap.xml" >> $GITHUB_WORKSPACE/www/robots.txt

      # --- [SEO & AdSense ÏµúÏ†ÅÌôî ÎÅù] ---

      - name: Add a nojekyll file
        run: touch $GITHUB_WORKSPACE/www/.nojekyll

      - name: Deploy üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: www