on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
permissions:
  contents: write
jobs:
  test:
    runs-on: ubuntu-latest
    name: Run the action on a test graph and publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build graph's SPA
        uses: logseq/publish-spa@main
        with:
          graph-directory: .
          theme-mode: light
          accent-color: blue

      # --- [SEO & AdSense Optimization starts] ---

      - name: AdSense - Inject Meta Tag & Script
        run: |
          # 1. Meta Tag injection - first point where Google verifies your domain ownership
          META_TAG='<meta name="google-adsense-account" content="ca-pub-9169085414093593">'
          
          # 2. AdSense script
          ADSENSE_SCRIPT='<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9169085414093593" crossorigin="anonymous"></script>'
          
          # Inject both codes right before the </head> tag
          # \n to add a newline for better source code readability
          sed -i "s|</head>|$META_TAG\n$ADSENSE_SCRIPT\n</head>|g" $GITHUB_WORKSPACE/www/index.html

      - name: AdSense - Create ads.txt
        run: echo "google.com, ca-pub-9169085414093593, DIRECT, f08c47fec0942fa0" > $GITHUB_WORKSPACE/www/ads.txt

      - name: SEO - Create 404.html for History API
        run: cp $GITHUB_WORKSPACE/www/index.html $GITHUB_WORKSPACE/www/404.html

      - name: SEO - Generate Dynamic Sitemap
        run: |
          DOMAIN="https://dev.o-m.kr"
          echo "<?xml version='1.0' encoding='UTF-8'?>" > $GITHUB_WORKSPACE/www/sitemap.xml
          echo "<urlset xmlns='http://www.sitemaps.org/schemas/sitemap/0.9'>" >> $GITHUB_WORKSPACE/www/sitemap.xml
          
          # Code to fix XML parse errors caused by special characters.
          find . -maxdepth 2 -name "*.md" ! -name "logseq*" | sed "s|^\./||" | sed "s|.md$||" | while read page; do
            # Replace `&` symbol with `&amp;` in URL
            SAFE_PAGE=$(echo "$page" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'"'"'/\&apos;/g')
            echo "<url><loc>$DOMAIN/#/page/$SAFE_PAGE</loc></url>" >> $GITHUB_WORKSPACE/www/sitemap.xml
          done
          
          echo "</urlset>" >> $GITHUB_WORKSPACE/www/sitemap.xml

      - name: SEO - Create robots.txt
        run: |
          echo "User-agent: *" > $GITHUB_WORKSPACE/www/robots.txt
          echo "Allow: /" >> $GITHUB_WORKSPACE/www/robots.txt
          echo "Sitemap: https://dev.o-m.kr/sitemap.xml" >> $GITHUB_WORKSPACE/www/robots.txt

      # --- [SEO & AdSense Optimization completed] ---

      - name: Add a nojekyll file
        run: touch $GITHUB_WORKSPACE/www/.nojekyll

      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: www